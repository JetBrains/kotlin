// DISCLAIMER:
// THIS IS A SCRATCH FILE USED TO PLAN THIS PROTOTYPE.
// ALL THE ASCII ARTS ARE GENERATED BY GEMINI.

// ACTION PLAN:
//

// -------------------------------------------------------------------------------------------

// TODO: So, this launcher should be used when compiled with hot-code reload support.
// TODO: This launcher should initialize the JITLinker and the HotReload Runtime.
// TODO: The first task of this launcher is loading the `bootstrap.o` object.
// TODO: Once the first user-linking is done, the program can actually start.

// TODO: As far as I can see from the compilation process, when compiling for macOS
// TODO: we have three LLVM bitcode files taken in consideration:
// TODO: 1. User Code (Kotlin/Native code written by the user)
// TODO: 2. Obj-C Support
// TODO: 3. Launcher (responsible to start-up the K/N program)

// TODO: Now, for this experiment. The main executable should just contain the hot-reload launcher
// TODO: and the Obj-C Support (at least, for macOS :)).

// TODO: Now, for iOS Applications, the BootStrap Object can be bundled in the NSBundle.
// TODO: For macOS, Windows and Linux, the boostrap object could be located in the same folder,
// TODO: but this approach seems to be more prone to errors (like, user deleting the bootstrap file).
// TODO: So, an idea, would be to create a unified executable, similar to what LÃ¶ve2D does.
// TODO: That is, appending the bootstrap object at the end of the main executable, and
// TODO: write a footer on how to fetch this binary.

//+-------------------------------------------------------+ <--- File Start (0x00)
//|                                                       |
//|   HOST EXECUTABLE (The Launcher)                      |
//|                                                       |
//|   [ Kotlin/Native Runtime (GC, MM, Alloc) ]           |
//|   [ JITLink Infrastructure (LLVM ORC)     ]           |
//|   [ HotReload Controller                  ]           |
//|   [ Obj-C / Platform Stubs                ]           |
//|   [ Symbol Table (Exports for User Code)  ]           |
//|                                                       |
//+-------------------------------------------------------+ <--- Offset X
//|                                                       |
//|   BOOTSTRAP OBJECT (bootstrap.o)                      |
//|                                                       |
//|   [ Compiled User Code (Machine Code)     ]           |
//|   [ Metadata (KTypeInfo, etc.)            ]           |
//|   [ Symbol: _Konan_start                  ]           |
//|                                                       |
//+-------------------------------------------------------+ <--- Offset Y
//|   BOOTSTRAP FOOTER                                    |
//|   [ Magic Number (e.g., "HOTK") ]                     |
//|   [ Offset to Start of Bootstrap (Offset X) ]         |
//|   [ Size of Bootstrap Object ]                        |
//+-------------------------------------------------------+ <--- EOF

// TODO: Then it would be sufficient to extract this executable in /tmp/ folder and that's it.

// TODO: We don't care for Android atm.

#ifndef HOT_LAUNCHER_H
#define HOT_LAUNCHER_H

#ifdef __cplusplus
extern "C" {
#endif

// TODO: Kotlin_initRuntimeIfNeeded will initialize the HotReload module.
// TODO: The architecture is split as it follows:
// TODO: HotReload Module (contained within the K/N Runtime) and the Hot Reload Launcher (preparing the HotReload module for stubs creation and so on).

// TODO: `Konan_start`, the main entry point for the K/N user's code, does need to be referenced in the launcher.
// TODO: JITLink will be responsible to lookup for this symbol in the boostrap object and run it...

//STEP 1: LAUNCH             STEP 2: EXTRACTION                 STEP 3: JIT LINKING
//+-------------------+      +-----------------------+          +-------------------------+
//|                   |      |                       |          |                         |
//|  OS loads Host    |----->|  Launcher reads       |--------->|  JITLink processes      |
//|  Executable into  |      |  its own binary tail  |          |  the memory buffer      |
//|  Memory           |      |  (Footer parsing)     |          |                         |
//|                   |      |                       |          |                         |
//+-------------------+      +-----------+-----------+          +------------+------------+
//                                       |                                   |
//                                       v                                   |
//                            (Optimization: mmap,                           v
//                             don't write to /tmp                        [Symbol Resolution]
//                             if possible)                                  |
//                                                                           | 1. Resolve External
//                                                                           |    symbols in .o against
//                                                                           |    Host Runtime (malloc,
//                                                                           |    Kotlin classes)
//                                                                           |
//                                                                           | 2. Apply Relocations
//                                                                           |
//                                                                           v
//   STEP 5: EXECUTION          STEP 4: HANDSHAKE               +-------------------------+
//+-------------------+      +-----------------------+          |                         |
//|                   |      |                       |          |  EXECUTABLE MEMORY      |
//|  Run Loop /       |<-----|  Lookup _Konan_start  |<---------|  (RX - Read/Execute)    |
//|  App Logic        |      |  in JIT Session       |          |                         |
//|                   |      |                       |          |  [ User Code Live ]     |
//+-------------------+      +-----------------------+          +-------------------------+

#ifdef __cplusplus
}
#endif

#endif // HOT_LAUNCHER_H













