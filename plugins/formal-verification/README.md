# Formal Verification for Kotlin

This plugin performs formal verification of Kotlin Contracts by translating them to Viper.

## Translation structure

We translate Kotlin programs function-by-function into Viper, mapping a single function
and all its dependencies into a Viper method and accompanying method signatures.
The data structures involved can be split into four stages, numbered from Kotlin to Viper.

1. The FIR tree: `kotlinc`'s frontend representation of the code.
2. Embeddings of Kotlin constructs: our internal representations of Kotlin constructs, adjusted
   to make them easier to translate to Viper.  This is primarily done with things like types and
   function signatures, that have to be referred to often.
3. Kotlin wrappers for Silver: since Viper is written in Scala, we have very thin,
   mostly one-to-one wrappers around its structures that are easier to create from Kotlin.
4. The Silver AST: the Scala representation of Viper syntax.

Note that not all constructs are represented at every step: in particular, Kotlin functions
are directly mapped to our Kotlin wrappers for Silver, going from 1 to 3 while skipping 2. 
We refer to the step from 1 to 2 as "embedding" and from 1 to 3 as "conversion".


A few notes:
- Conversion from stage 1 is performed using `Converter`s, which operate in a particular `ConversionContext`.
  - When writing a class is not worth it, call the method `convertXtoY` or `processX` if the result is not so clear-cut.
- Prefer to create wrappers for all Silver constructs, even if they're simple.
- The name `toViper` should be used exclusively for functions that go from step 3 to step 4.
- For getting the conversion results as stage 3 structures, use either a property named after the
  thing to be returned (e.g. `program`, `method`) or a function named after it (e.g. `toLocalVar`, `toType`).
- Utility functions of stage 3 nodes for constructing other stage 3 nodes should be named after the
  node they construct (e.g. `funcApp`).

## Directory structure:

- `formver.embeddable`: Separate target necessary for the Gradle plugin.
- `formver.cli`: Command-line processor and plugin loading implementation.
- `formver.core`: Core conversion logic and associated data structures.
  - `formver.core/.../conversion`: Conversion logic from the FIR to Viper
  - `formver.core/.../embeddings`: Embedded versions of Kotlin constructs.
- `formver.plugin`: Infrastructure for packaging our conversion as a plugin and reporting verification errors.
- `formver.viper`: Wrappers around Viper code. This is the only place any direct reference to Viper is permitted!
  - `formver.viper/.../ast/`: Wrappers around Silver data structures.
  - `formver.viper/.../domains/`: New domains that we need for our conversion.
- `testData/diagnostics`: Test suite of example programs.  Only the `.kt` files are human-written:
  the rest is generated automatically when running the tests in `tests-gen`.
- `tests`: Harness for running our automated tests.  Manual tests should also be put here.
- `tests-gen`: Tests generated by `:generators:generateTests`.  Rerun that when you add files to `testData`.
