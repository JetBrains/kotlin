/*
 * Copyright 2010-2026 JetBrains s.r.o. and Kotlin Programming Language contributors.
 * Use of this source code is governed by the Apache 2.0 license that can be found in the license/LICENSE.txt file.
 */

package org.jetbrains.kotlin.load.java.structure.impl;

import com.intellij.psi.PsiAnnotationOwner;
import com.intellij.psi.PsiParameter;
import com.intellij.psi.impl.compiled.ClsParameterImpl;
import com.intellij.psi.impl.java.stubs.PsiParameterStub;
import com.intellij.psi.impl.java.stubs.impl.PsiParameterStubImpl;
import kotlin.text.StringsKt;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.kotlin.descriptors.Visibilities;
import org.jetbrains.kotlin.descriptors.Visibility;
import org.jetbrains.kotlin.load.java.structure.JavaAnnotation;
import org.jetbrains.kotlin.load.java.structure.JavaType;
import org.jetbrains.kotlin.load.java.structure.JavaValueParameter;
import org.jetbrains.kotlin.load.java.structure.impl.source.JavaElementPsiSource;
import org.jetbrains.kotlin.name.FqName;
import org.jetbrains.kotlin.name.Name;

import java.util.Collection;

public class JavaValueParameterImpl extends JavaElementImpl<PsiParameter>
        implements JavaValueParameter, JavaAnnotationOwnerImpl, JavaModifierListOwnerImpl {
    public JavaValueParameterImpl(@NotNull JavaElementPsiSource<PsiParameter> psiParameterSource) {
        super(psiParameterSource);
    }

    @Nullable
    @Override
    public PsiAnnotationOwner getAnnotationOwnerPsi() {
        return getPsi().getModifierList();
    }

    @Override
    public boolean isAbstract() {
        return false;
    }

    @Override
    public boolean isStatic() {
        return false;
    }

    @Override
    public boolean isFinal() {
        return false;
    }

    @Override
    public boolean isFromSource() {
        return !JavaPsiUtilsKt.isCompiledElement(getPsi());
    }

    @NotNull
    @Override
    public Visibility getVisibility() {
        return Visibilities.Local.INSTANCE;
    }

    @NotNull
    @Override
    public Collection<JavaAnnotation> getAnnotations() {
        return JavaElementUtil.getRegularAndExternalAnnotations(this, getSourceFactory());
    }

    @Nullable
    @Override
    public JavaAnnotation findAnnotation(@NotNull FqName fqName) {
        return JavaElementUtil.findAnnotation(this, fqName, getSourceFactory());
    }

    @Override
    public boolean isDeprecatedInJavaDoc() {
        return false;
    }

    @Override
    @Nullable
    public Name getName() {
        PsiParameter psi = getPsi();
        if (psi instanceof ClsParameterImpl && ((ClsParameterImpl) psi).isAutoGeneratedName()) {
            return null;
        }

        String name = psi.getName();
        return Name.identifier(name);
    }

    @Override
    public @NotNull Name getNameOrGeneratedName() {
        PsiParameter psi = getPsi();
        if (psi instanceof ClsParameterImpl) {
            PsiParameterStub parameterStub = ((ClsParameterImpl) psi).getStub();
            return normalizedName(parameterStub);
        }

        String name = psi.getName();
        return Name.identifier(name);
    }

    // Pre-computed normalized names for p1-p9 â†’ p0-p8 to avoid substring allocation, integer parsing, and Name allocation
    private static final Name[] NORMALIZED_GENERATED_NAMES = {
            Name.identifier("p0"), Name.identifier("p1"), Name.identifier("p2"),
            Name.identifier("p3"), Name.identifier("p4"), Name.identifier("p5"),
            Name.identifier("p6"), Name.identifier("p7"), Name.identifier("p8")
    };

    private static @NotNull Name normalizedName(@NotNull PsiParameterStub parameterStub) {
        String name = parameterStub.getName();

        // Auto-generated names are p1, p2, p3, etc., so we need to convert then to p0, p1, p2, etc.
        if (parameterStub instanceof PsiParameterStubImpl &&
            ((PsiParameterStubImpl) parameterStub).isAutoGeneratedName() &&
            name.length() > 1 &&
            name.charAt(0) == 'p') {
            // Fast path for p1-p9 (most common case)
            if (name.length() == 2) {
                char c = name.charAt(1);
                if (c >= '1' && c <= '9') {
                    return NORMALIZED_GENERATED_NAMES[c - '1'];
                }
            }

            // Fallback for p10+ or unexpected formats
            Integer parameterIndex = StringsKt.toIntOrNull(name.substring(1));
            if (parameterIndex == null) return Name.identifier(name);

            int normalizedIndex = parameterIndex - 1;
            return Name.identifier("p" + normalizedIndex);
        }

        return Name.identifier(name);
    }

    @Override
    @NotNull
    public JavaType getType() {
        return JavaTypeImpl.create(getPsi().getType(), createVariableReturnTypeSource(psiElementSource));
    }

    @Override
    public boolean isVararg() {
        return getPsi().isVarArgs();
    }
}
