#!/bin/bash
set -e
export KONAN_USE_INTERNAL_SERVER=1
ROOT="$(pwd)"
KV=2.4.255-SNAPSHOT
GRADLE_HOME="$HOME/.gradle"

./gradlew clean distCompiler

function generate {
TARGET="$1"
echo "$TARGET"

cd "$ROOT"/kotlin-native/libclangInterop
/Users/jetbrains/Library/Java/JavaVirtualMachines/temurin-21.0.8/Contents/Home/bin/java -Djava.library.path="$ROOT"/kotlin-native/libclangInterop/build:"$ROOT"/kotlin-native/Interop/Runtime/build -Dkonan.home="$ROOT"/kotlin-native -Dfile.encoding=UTF-8 -Duser.country=US -Duser.language=en -Duser.variant -ea -cp "$ROOT"/kotlin-native/Interop/StubGenerator/build/libs/StubGenerator-"$KV".jar:"$ROOT"/kotlin-native/Interop/Indexer/build/libs/Indexer-"$KV".jar:"$ROOT"/kotlin-native/libclangInterop/build/libs/libclangInterop-"$KV".jar:"$ROOT"/kotlin-native/endorsedLibraries/kotlinx.cli/build/libs/kotlinx.cli-jvm-"$KV".jar:"$ROOT"/libraries/kotlinx-metadata/klib/build/libs/kotlinx-metadata-klib-0.0.1-SNAPSHOT.jar:"$ROOT"/compiler/ir/serialization.common/build/libs/ir.serialization.common-"$KV".jar:"$ROOT"/kotlin-native/Interop/Runtime/build/libs/Runtime-"$KV".jar:"$ROOT"/compiler/ir/ir.tree/build/libs/ir.tree-"$KV".jar:"$ROOT"/compiler/serialization/build/libs/serialization-"$KV".jar:"$ROOT"/compiler/frontend.common-psi/build/libs/frontend.common-psi-"$KV".jar:"$ROOT"/compiler/psi/psi-frontend-utils/build/libs/psi-frontend-utils-"$KV".jar:"$ROOT"/compiler/psi/psi-utils/build/libs/psi-utils-"$KV".jar:"$ROOT"/compiler/psi/psi-impl/build/libs/psi-impl-"$KV".jar:"$ROOT"/compiler/psi/parser/build/libs/parser-"$KV".jar:"$ROOT"/compiler/psi/psi-api/build/libs/psi-api-"$KV".jar:"$ROOT"/compiler/frontend.common/build/libs/frontend.common-"$KV".jar:"$ROOT"/compiler/plugin-api/build/libs/plugin-api-"$KV".jar:"$ROOT"/compiler/resolution/build/libs/resolution-"$KV".jar:"$ROOT"/compiler/resolution.common/build/libs/resolution.common-"$KV".jar:"$ROOT"/compiler/config/build/libs/config-"$KV".jar:"$ROOT"/compiler/util/build/libs/util-"$KV".jar:"$ROOT"/libraries/stdlib/jdk8/build/libs/kotlin-stdlib-jdk8-"$KV".jar:"$ROOT"/native/utils/build/libs/kotlin-native-utils-"$KV".jar:"$ROOT"/compiler/util-klib-metadata/build/libs/kotlin-util-klib-metadata-"$KV".jar:"$ROOT"/compiler/util-klib/build/libs/kotlin-util-klib-"$KV".jar:"$ROOT"/compiler/util-io/build/libs/kotlin-util-io-"$KV".jar:"$ROOT"/libraries/stdlib/jdk7/build/libs/kotlin-stdlib-jdk7-"$KV".jar:"$ROOT"/core/deserialization/build/libs/deserialization-"$KV".jar:"$ROOT"/core/descriptors/build/libs/descriptors-"$KV".jar:"$ROOT"/core/deserialization.common/build/libs/deserialization.common-"$KV".jar:"$ROOT"/core/compiler.common/build/libs/compiler.common-"$KV".jar:"$ROOT"/core/metadata/build/libs/metadata-"$KV".jar:"$ROOT"/libraries/stdlib/build/libs/kotlin-stdlib-"$KV".jar:"$GRADLE_HOME"/caches/modules-2/files-2.1/org.jetbrains/annotations/13.0/919f0dfe192fb4e063e7dacadee7f8bb9a2672a9/annotations-13.0.jar:"$ROOT"/compiler/compiler.version/build/libs/compiler.version-"$KV".jar:"$ROOT"/compiler/container/build/libs/container-"$KV".jar:"$ROOT"/core/util.runtime/build/libs/util.runtime-"$KV".jar:"$GRADLE_HOME"/caches/modules-2/files-2.1/org.jetbrains.kotlin/kotlin-reflect/1.6.10/1cbe9c92c12a94eea200d23c2bbaedaf3daf5132/kotlin-reflect-1.6.10.jar:"$ROOT"/libraries/tools/script-runtime/build/libs/kotlin-script-runtime-"$KV".jar:"$ROOT"/libraries/tools/kotlin-annotations-jvm/build/libs/kotlin-annotations-jvm-"$KV".jar:"$GRADLE_HOME"/caches/modules-2/files-2.1/javax.inject/javax.inject/1/6975da39a7040257bd51d21a231b76c915872d38/javax.inject-1.jar:"$GRADLE_HOME"/caches/modules-2/files-2.1/org.jetbrains.kotlin/protobuf-lite/2.6.1-2/98e627a8d370109ca235095ce4916c2f8e1d0df2/protobuf-lite-2.6.1-2.jar org.jetbrains.kotlin.native.interop.gen.jvm.MainKt -generated "$ROOT"/kotlin-native/libclangInterop/build/nativeInteropStubs/kotlin -Xtemporary-files-dir "$ROOT"/kotlin-native/libclangInterop/build/nativeInteropStubs/c -flavor jvm -def "$ROOT"/kotlin-native/libclangInterop/clang.def -target "$TARGET" -Xoverride-konan-properties "predefinedLlvmDistributions=llvm-19-x86_64-linux-dev-109 llvm-19-x86_64-linux-essentials-109 llvm-19-aarch64-macos-dev-81 llvm-19-aarch64-macos-essentials-81 llvm-19-x86_64-macos-dev-77 llvm-19-x86_64-macos-essentials-77 llvm-19-x86_64-windows-dev-139 llvm-19-x86_64-windows-essentials-139;llvm-19-x86_64-linux-dev-109.default=remote:public:resources/llvm/19-x86_64-linux;llvm.linux_x64.dev=llvm-19-x86_64-linux-dev-109;llvm-19-x86_64-linux-essentials-109.default=remote:public:resources/llvm/19-x86_64-linux;llvm.linux_x64.user=llvm-19-x86_64-linux-essentials-109;llvm-19-aarch64-macos-dev-81.default=remote:public:resources/llvm/19-aarch64-macos;llvm.macos_arm64.dev=llvm-19-aarch64-macos-dev-81;llvm-19-aarch64-macos-essentials-81.default=remote:public:resources/llvm/19-aarch64-macos;llvm.macos_arm64.user=llvm-19-aarch64-macos-essentials-81;llvm-19-x86_64-macos-dev-77.default=remote:public:resources/llvm/19-x86_64-macos;llvm.macos_x64.dev=llvm-19-x86_64-macos-dev-77;llvm-19-x86_64-macos-essentials-77.default=remote:public:resources/llvm/19-x86_64-macos;llvm.macos_x64.user=llvm-19-x86_64-macos-essentials-77;llvm-19-x86_64-windows-dev-139.default=remote:public:resources/llvm/19-x86_64-windows;llvm.mingw_x64.dev=llvm-19-x86_64-windows-dev-139;llvm-19-x86_64-windows-essentials-139.default=remote:public:resources/llvm/19-x86_64-windows;llvm.mingw_x64.user=llvm-19-x86_64-windows-essentials-139;llvmVersion.linux_x64=19;llvmVersion.macos_arm64=19;llvmVersion.macos_x64=19;llvmVersion.mingw_x64=19" -compiler-option -std=c99 -compiler-option -I"$HOME"/.konan/dependencies/llvm-19-aarch64-macos-dev-81/include -compiler-option -I../libclangext/src/main/include

cp -r "$ROOT"/kotlin-native/libclangInterop/build/nativeInteropStubs/* "$ROOT"/kotlin-native/libclangInterop/gen/main-$TARGET/
}

generate macos_arm64
generate macos_x64
generate linux_x64
generate mingw_x64
