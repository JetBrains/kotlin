Cannot refactor due to erroneous code