This document describes properties of a different nodes (aka sets) representing parts of a parsed regular expression, and how they are calculated for different node types.

Currently, there are only 4 properties:
- `capturesGroups` - if evaluation of node updates information about capturing groups (stored in the match result)
- `tracksConsumption` - some nodes store information about their own consumption (for various reasons). That's a state stored and (not always trivially) updated within the match result
- `nonTrivialBacktracking` - indicates that a matching failure for a node after the current one may result in a backtracking requiring non-trivial evaluation (that may also modify the state).
- `requiresCheckpointing` - Look around sets creates match result's checkpoints and restore state from it.

### AbstractSet (and its sub-classes) properties

The table describes how properties are calculated. Note, that if there are some doubts about it, the most conservative approach is taken.
Each of the existing properties signify some complexity/additional state associated with set's matching, so a conservative value is
always `true` meaning that there is some state, and it is not that trivial to match the set. 

| Class                                    | Description                                                                                                                                                                                                                                                         | capturesGroups                   | tracksConsumption    | nonTrivialBacktracking                                           | requiresCheckpointing |
|------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|----------------------|------------------------------------------------------------------|-----------------------|
| AbstractSet (and SimpleSet)              | Base class(es)                                                                                                                                                                                                                                                      | undefined                        | undefined            | undefined                                                        | undefined             |
| . LeafSet                                | REs consuming fixed-length input. It's subclasses are all have trivial implementation                                                                                                                                                                               | false                            | false                | false                                                            | false                 |
| . . SequenceSet                          | String literal (like `abc`)                                                                                                                                                                                                                                         | false                            | false                | false                                                            | false                 |
| . . CharSet                              | Single character (like `a`)                                                                                                                                                                                                                                         | false                            | false                | false                                                            | false                 |
| . . . LowSurrogateCharSet                | Single low-surrogate character                                                                                                                                                                                                                                      | false                            | false                | false                                                            | false                 |
| . . . HighSurrogateCharSet               | Single high-surrogate character                                                                                                                                                                                                                                     | false                            | false                | false                                                            | false                 |
| . . EmptySet                             | Zero character match                                                                                                                                                                                                                                                | false                            | false                | false                                                            | false                 |
| . . RangeSet                             | Single character from a set (like `[abcde]`, `[A-Za-z0-9]`)                                                                                                                                                                                                         | false                            | false                | false                                                            | false                 |
| . . . SurrogateRangeSet                  | RangeSet containing only surrogate characters                                                                                                                                                                                                                       | false                            | false                | false                                                            | false                 |
| . HangulDecomposedCharSet                | Canonical decomposition of [Hangul syllable](https://en.wikipedia.org/wiki/Hangul_Syllables). While it can match multiple characters, once it matched, the number of characters remain the same.                                                                    | false                            | false                | false                                                            | false                 |
| . SupplementaryRangeSet                  | Single character from a character class (like `\d`)                                                                                                                                                                                                                 | false                            | false                | false                                                            | false                 |
| . DotSet                                 | Any single character except new line (`.`)                                                                                                                                                                                                                          | false                            | false                | false                                                            | false                 |
| . CompositeRangeSet                      | Range containing surrogate characters, splits range into two - regular characters and surrogate characters. All properties depend on properties of sets representing those two ranges.                                                                              | delegate to children             | delegate to children | delegate to children                                             | delegate to children  |
| . DecomposedCharSet                      | Canonical decomposition of a single unicode character.                                                                                                                                                                                                              | false                            | false                | false                                                            | false                 |
| . WordBoundarySet                        | Matches boundary between two words. Looks at two adjacent characters. (Why it does not track consumption?)                                                                                                                                                          | false                            | false                | false                                                            | false                 |
| . EOLSet                                 | Matches `$` - anchoring bound. Stores information about its consumption to correctly work with quantified sets. It's a zero-length match, without consumption info, quantifiers can't stop applying it.                                                             | false                            | true                 | false                                                            | false                 |
| . SOLSet                                 | Matches `^` - anchoring bound.                                                                                                                                                                                                                                      | false                            | false                | false                                                            | false                 |
| . EOISet                                 | End of the input (`\z`)                                                                                                                                                                                                                                             | false                            | false                | false                                                            | false                 |
| . PreviousMatchSet                       | End of the previous match (`\G`)                                                                                                                                                                                                                                    | false                            | false                | false                                                            | false                 |
| . BackReferenceSet                       | Back reference to a previously matched group. It tracks its consumption (apparently, because match could be empty). It's unclear if it can change it's value during backtracking, I conservatively assumed that it can.                                             | false                            | true                 | true (conservative guess)                                        | false                 |
| . JointSet                               | A capturing group consisting of multiple alternative subexpressions (`(<expr 1>\| <expr 2>\| ....)`). It captures group info, but all other properties are delegated to children sets. However, if there are more than 1 child - backtracking is always non trivial | true                             | delegate to children | true if len(children) > 1, otherwise delegate to children        | delegate to children  |
| . . SingleSet                            | A capturing group consisting of a single subexpression. It captures group info, all other properties are gathered from children.                                                                                                                                    | true                             | delegate to children | delegate to children                                             | delegate to children  |
| . . . BackReferencedSingleSet            | A SingleSet referred somewhere using a backreference. All properties are the same as for regular SingleSet.                                                                                                                                                         | true                             | delegate to children | delegate to children                                             | delegate to children  | 
| . . NonCapturingJointSet                 | A non-capturing group of arbitrary number of sub-expressions. It is non-trivial for backtracking if there are multiple children, it tracks consumption (TODO: why?). All other properties are delegated.                                                            | false                            | true                 | true if len(children) > 1, otherwise delegate to children        | delegate to children  |
| . . . AtomicJointSet                     | An [atomic group](https://www.regular-expressions.info/atomic.html). It (conservatively) inherits all properties from the NonCapturingJointSet. However, it's backtracking could be trivial, since it's atomic (need to investigate).                               | false                            | true                 | true if len(children) > 1, otherwise delegate to children (TODO) | delegate to children  |   
| . . . . LookAroundSet                    | Read the remark after the table.                                                                                                                                                                                                                                    |                                  |                      |                                                                  |                       |    
| . . . . . PositiveLookBehindSet          | Read the remark after the table.                                                                                                                                                                                                                                    | delegate to children             | false                | true                                                             | true                  |
| . . . . . NegativeLookBehindSet          | Read the remark after the table.                                                                                                                                                                                                                                    | delegate to children             | false                | true                                                             | true                  |
| . . . . . PositiveLookAheadSet           | Read the remark after the table.                                                                                                                                                                                                                                    | delegate to children             | true                 | true                                                             | true                  |
| . . . . . NaegativeLookAheadSet          | Read the remark after the table.                                                                                                                                                                                                                                    | delegate to children             | true                 | true                                                             | true                  |
| . QuantifierSet                          | Base class for quantified sets.                                                                                                                                                                                                                                     |                                  |                      |                                                                  |                       |
| . . LeafQuantifierSet                    | Quantified LeafSet. LeafSets are all trivial and don't affect properties. However, this set has an FSet associated with it and we gather properties from it. If quantifier has fixed number of repetitions (`{2, 2}`, `{100, 100}`) - it's trivial to backtrack.    | delegate to fset                 | delegate to fset     | delegate to fset, true if repetition number is not fixed         | delegate to fset      |
| . . . ReluctantLeafQuantifierSet         | Reluctant (lazy) quantified LeafSet. All properties works exactly like for LeafQuantifierSet.                                                                                                                                                                       |                                  |                      |                                                                  |                       |
| . . . PossessiveLeafQuantifierSet        | Posessive (sticky) quantified LeafSet. All properties works exactly like for LeafQuantifierSet (TODO: it should be always trivial to backtrack, though).                                                                                                            |                                  |                      |                                                                  |                       |
| . . . UnifiedQuantifierSet               | Special optimized version of the LeafQuantifierSet.                                                                                                                                                                                                                 | delegate to children             | delegate to children | delegate to children, true if repetition number is not fixed     | delegate to children  |
| . . DotQuantifierSet                     | Optimized implementation of `.*`. It's `*`, so it is non trivial for backtracking. All other properties are collected from children (which should always be DotSet? TODO)                                                                                           | delegate to children             | delegate to children | true                                                             | delegate to children  |
| . . FixedLengthQuantifierSet             | Quantified set, where the inner set consumes a fixed number of characters.                                                                                                                                                                                          | delegate to children             | delegate to children | delegate to children, true if repetition number is not fixed     | delegate to children  |
| . . . ReluctantFixedLengthQuantifierSet  | Lazy version of FixedLengthQuantifierSet. All properties are calculated like for FixedLengthQuantifierSet                                                                                                                                                           |                                  |                      |                                                                  |                       |
| . . . PossessiveFixedLengthQuantifierSet | Sticky version of FixedLengthQuantifierSet. All properties are calculated like for FixedLengthQuantifierSet (although, backtracking should be trivial? TODO)                                                                                                        |                                  |                      |                                                                  |                       |
| . . GroupQuantifierSet                   | Quantified capturing group. It is non trivial for backtracking, all other properties are gathered from the quantified group.                                                                                                                                        | delegate to children (it's true) | delegate to children | true                                                             | delegate to children  |
| . . . PossessiveGroupQuantifierSet       | Sticky version of GroupQuantifierSet. All properties are calculated the same way, but it is considered trivial for backtracking if the number of repetitions is fixed.                                                                                              | delegate to children (it's true) | delegate to children | true                                                             | delegate to children  |
| . . . ReluctantGroupQuantifierSet        | Lazy version of GroupQuantifierSet. All properties are calculated the same way.                                                                                                                                                                                     | delegate to children (it's true) | delegate to children | true (depends on the number of repetitions, TODO)                | delegate to children  |
| . . TrivialGroupQuantifierSet            | Optimized version of GroupQuantifierSet added in this PR. All properties collected from the children group, but it is conservatively considered non-trivial for backtracking.                                                                                       | delegate to children             | delegate to children | true (conservative)                                              | delegate to children  |
| . . ReluctantTrivialGroupQuantifierSet   | Optimized version of ReluctantGroupQuantifierSet added in this PR. All properties collected from the children group, but it is conservatively considered non-trivial for backtracking.                                                                              | delegate to children             | delegate to children | true (conservative)                                              | delegate to children  |
| . FSet                                   | End of a group. It captures the state, but all other properties are default.                                                                                                                                                                                        | true                             | false                | false                                                            | false                 |
| . . FinalSet                             | End of the pattern. All properties are default.                                                                                                                                                                                                                     | false                            | false                | false                                                            | false                 |
| . . NonCapFSet                           | End of a non-capturing group. But it captures information about its consumption! (Why?)                                                                                                                                                                             | false                            | true                 | false                                                            | false                 |
| . . AheadFSet                            | End of a look-ahead group. All properties are default.                                                                                                                                                                                                              | false                            | false                | false                                                            | false                 |
| . . BehindFSet                           | End of a look-behind group. All properties are default.                                                                                                                                                                                                             | false                            | false                | false                                                            | false                 |
| . . AtomicFSet                           | End of an atomic group. It tracks its own consumption (why?), otherwise all properties are default.                                                                                                                                                                 | false                            | true                 | false                                                            | false                 |
| . PossessiveFSet                         | End of a non-backtrackable group. All properties are default.                                                                                                                                                                                                       | false                            | false                | false                                                            | false                 | 


### On Look-around sets and checkpointing.

Look-around sets (which are atomic) [creates a snapshot](https://github.com/JetBrains/kotlin/blob/349222dc13d0c0da96c9926453869720a2d0a42c/libraries/stdlib/native-wasm/src/kotlin/text/regex/sets/LookAroundSet.kt#L17) of the current match result state before matching, and rollback to that state if the matching failed.
How checkpointing should work with quantified group evaluation is not 100% clear, so for now properties of these sets are as bad as they could be, preventing any optimization that could otherwise be appleid to them. 
