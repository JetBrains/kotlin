/*
 * Copyright 2010-2019 JetBrains s.r.o. and Kotlin Programming Language contributors.
 * Use of this source code is governed by the Apache 2.0 license that can be found in the license/LICENSE.txt file.
 */

package org.jetbrains.kotlin.idea.quickfix

import com.intellij.facet.FacetManager
import com.intellij.facet.impl.FacetUtil
import com.intellij.openapi.module.Module
import com.intellij.openapi.roots.ModuleRootModificationUtil.updateModel
import com.intellij.openapi.roots.OrderRootType
import com.intellij.openapi.roots.ui.configuration.libraryEditor.NewLibraryEditor
import com.intellij.openapi.util.io.FileUtil
import com.intellij.openapi.vfs.JarFileSystem
import com.intellij.openapi.vfs.LocalFileSystem
import com.intellij.testFramework.fixtures.LightPlatformCodeInsightFixtureTestCase
import org.jetbrains.kotlin.cli.common.arguments.CommonCompilerArguments.Companion.DEFAULT
import org.jetbrains.kotlin.config.CompilerSettings.Companion.DEFAULT_ADDITIONAL_ARGUMENTS
import org.jetbrains.kotlin.config.LanguageFeature
import org.jetbrains.kotlin.config.LanguageVersion
import org.jetbrains.kotlin.idea.compiler.configuration.KotlinCommonCompilerArgumentsHolder
import org.jetbrains.kotlin.idea.compiler.configuration.KotlinCompilerSettings
import org.jetbrains.kotlin.idea.configuration.KotlinJavaModuleConfigurator
import org.jetbrains.kotlin.idea.facet.KotlinFacetType
import org.jetbrains.kotlin.idea.facet.getRuntimeLibraryVersion
import org.jetbrains.kotlin.idea.project.getLanguageVersionSettings
import org.jetbrains.kotlin.idea.project.languageVersionSettings
import org.jetbrains.kotlin.idea.test.ConfigLibraryUtil
import org.jetbrains.kotlin.idea.test.configureKotlinFacet
import org.jetbrains.kotlin.idea.versions.bundledRuntimeVersion
import org.jetbrains.kotlin.test.JUnit3WithIdeaConfigurationRunner
import org.jetbrains.kotlin.utils.KotlinPaths
import org.jetbrains.kotlin.utils.PathUtil
import org.junit.runner.RunWith
import java.io.File

@RunWith(JUnit3WithIdeaConfigurationRunner::class)
class UpdateConfigurationQuickFixTest : LightPlatformCodeInsightFixtureTestCase() {

    val module: Module get() = myModule

    fun testDisableInlineClasses() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_3)
        myFixture.configureByText("foo.kt", "inline class My(val n: Int)")

        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, inlineClassesSupport)
        assertTrue(myFixture.availableIntentions.none { it.text == "Disable inline classes support in the project" })
    }

    fun testEnableInlineClasses() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_3)
        myFixture.configureByText("foo.kt", "inline class My(val n: Int)")

        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, inlineClassesSupport)
        myFixture.launchAction(myFixture.findSingleIntention("Enable inline classes support in the project"))
        assertEquals(LanguageFeature.State.ENABLED, inlineClassesSupport)
    }

    fun testEnableCoroutines() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_1)
        myFixture.configureByText("foo.kt", "suspend fun foo()")

        assertEquals(DEFAULT, KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.coroutinesState)
        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, coroutineSupport)
        myFixture.launchAction(myFixture.findSingleIntention("Enable coroutine support in the project"))
        assertEquals(LanguageFeature.State.ENABLED, coroutineSupport)
    }

    fun testDisableCoroutines() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_1)
        myFixture.configureByText("foo.kt", "suspend fun foo()")

        assertEquals(DEFAULT, KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.coroutinesState)
        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, coroutineSupport)
        myFixture.launchAction(myFixture.findSingleIntention("Disable coroutine support in the project"))
        assertEquals(LanguageFeature.State.ENABLED_WITH_ERROR, coroutineSupport)
    }

    fun testEnableCoroutinesFacet() {
        configureRuntime("mockRuntime11")
        val facet = configureKotlinFacet(module) {
            settings.languageLevel = LanguageVersion.KOTLIN_1_1
        }
        resetProjectSettings(LanguageVersion.KOTLIN_1_1)
        myFixture.configureByText("foo.kt", "suspend fun foo()")

        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, facet.configuration.settings.coroutineSupport)
        myFixture.launchAction(myFixture.findSingleIntention("Enable coroutine support in the current module"))
        assertEquals(LanguageFeature.State.ENABLED, facet.configuration.settings.coroutineSupport)
    }

    fun testEnableCoroutines_UpdateRuntime() {
        configureRuntime("mockRuntime106")
        resetProjectSettings(LanguageVersion.KOTLIN_1_1)
        myFixture.configureByText("foo.kt", "suspend fun foo()")

        assertEquals(LanguageFeature.State.ENABLED_WITH_WARNING, coroutineSupport)
        myFixture.launchAction(myFixture.findSingleIntention("Enable coroutine support in the project"))
        assertEquals(LanguageFeature.State.ENABLED, coroutineSupport)
        assertEquals(bundledRuntimeVersion(), getRuntimeLibraryVersion(myFixture.module))
    }

    fun testIncreaseLangLevel() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_0)
        myFixture.configureByText("foo.kt", "val x get() = 1")

        myFixture.launchAction(myFixture.findSingleIntention("Set project language version to 1.1"))

        assertEquals("1.1", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.languageVersion)
        assertEquals("1.0", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.apiVersion)
    }

    fun testIncreaseLangLevelFacet() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_0)
        configureKotlinFacet(module) {
            settings.languageLevel = LanguageVersion.KOTLIN_1_0
            settings.apiLevel = LanguageVersion.KOTLIN_1_0
        }
        myFixture.configureByText("foo.kt", "val x get() = 1")

        assertEquals(LanguageVersion.KOTLIN_1_0, module.languageVersionSettings.languageVersion)
        myFixture.launchAction(myFixture.findSingleIntention("Set module language version to 1.1"))
        assertEquals(LanguageVersion.KOTLIN_1_1, module.languageVersionSettings.languageVersion)
    }

    fun testIncreaseLangAndApiLevel() {
        configureRuntime("mockRuntime11")
        resetProjectSettings(LanguageVersion.KOTLIN_1_0)
        myFixture.configureByText("foo.kt", "val x = <caret>\"s\"::length")

        myFixture.launchAction(myFixture.findSingleIntention("Set project language version to 1.1"))

        assertEquals("1.1", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.languageVersion)
        assertEquals("1.1", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.apiVersion)
    }

    fun testIncreaseLangAndApiLevel_10() {
        configureRuntime("mockRuntime106")
        resetProjectSettings(LanguageVersion.KOTLIN_1_0)
        myFixture.configureByText("foo.kt", "val x = <caret>\"s\"::length")

        myFixture.launchAction(myFixture.findSingleIntention("Set project language version to 1.1"))

        assertEquals("1.1", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.languageVersion)
        assertEquals("1.1", KotlinCommonCompilerArgumentsHolder.getInstance(project).settings.apiVersion)

        assertEquals(bundledRuntimeVersion(), getRuntimeLibraryVersion(myFixture.module))
    }

    fun testIncreaseLangLevelFacet_10() {
        configureRuntime("mockRuntime106")
        resetProjectSettings(LanguageVersion.KOTLIN_1_0)
        configureKotlinFacet(module) {
            settings.languageLevel = LanguageVersion.KOTLIN_1_0
            settings.apiLevel = LanguageVersion.KOTLIN_1_0
        }
        myFixture.configureByText("foo.kt", "val x = <caret>\"s\"::length")

        assertEquals(LanguageVersion.KOTLIN_1_0, module.languageVersionSettings.languageVersion)
        myFixture.launchAction(myFixture.findSingleIntention("Set module language version to 1.1"))
        assertEquals(LanguageVersion.KOTLIN_1_1, module.languageVersionSettings.languageVersion)

        assertEquals(bundledRuntimeVersion(), getRuntimeLibraryVersion(myFixture.module))
    }

    fun testAddKotlinReflect() {
        configureRuntime("actualRuntime")
        myFixture.configureByText(
            "foo.kt", """class Foo(val prop: Any) {
                fun func() {}
            }

            fun y01() = Foo::prop.gett<caret>er
            """
        )
        myFixture.launchAction(myFixture.findSingleIntention("Add kotlin-reflect.jar to the classpath"))
        val kotlinRuntime = KotlinJavaModuleConfigurator.instance.getKotlinLibrary(module)!!
        val classes = kotlinRuntime.getFiles(OrderRootType.CLASSES).map { it.name }
        assertContainsElements(classes, "kotlin-reflect.jar")
        val sources = kotlinRuntime.getFiles(OrderRootType.SOURCES)
        assertContainsElements(sources.map { it.name }, "kotlin-reflect-sources.jar")
    }

    private fun configureRuntime(path: String) {
        val name = if (path == "mockRuntime106") "kotlin-runtime.jar" else "kotlin-stdlib.jar"
        val sourcePath = when (path) {
            "actualRuntime" -> PathUtil.kotlinPathsForIdeaPlugin.jar(KotlinPaths.Jar.StdLib)
            else -> File("idea/testData/configuration/$path/$name")
        }
        val tempFile = File(FileUtil.createTempDirectory("kotlin-update-configuration", null), name)
        FileUtil.copy(sourcePath, tempFile)
        val tempVFile = LocalFileSystem.getInstance().refreshAndFindFileByIoFile(tempFile) ?: error("Can't find file: $tempFile")

        updateModel(myFixture.module) { model ->
            val editor = NewLibraryEditor()
            editor.name = "KotlinJavaRuntime"

            editor.addRoot(JarFileSystem.getInstance().getJarRootForLocalFile(tempVFile)!!, OrderRootType.CLASSES)

            ConfigLibraryUtil.addLibrary(editor, model)
        }
    }

    private fun resetProjectSettings(version: LanguageVersion) {
        KotlinCompilerSettings.getInstance(project).update {
            additionalArguments = DEFAULT_ADDITIONAL_ARGUMENTS
        }
        KotlinCommonCompilerArgumentsHolder.getInstance(project).update {
            languageVersion = version.versionString
            apiVersion = version.versionString
            coroutinesState = DEFAULT
        }
    }

    private val coroutineSupport: LanguageFeature.State
        get() = project.getLanguageVersionSettings().getFeatureSupport(LanguageFeature.Coroutines)

    private val inlineClassesSupport: LanguageFeature.State
        get() = project.getLanguageVersionSettings().getFeatureSupport(LanguageFeature.InlineClasses)

    override fun tearDown() {
        resetProjectSettings(LanguageVersion.KOTLIN_1_3)
        FacetManager.getInstance(module).getFacetByType(KotlinFacetType.TYPE_ID)?.let {
            FacetUtil.deleteFacet(it)
        }
        ConfigLibraryUtil.removeLibrary(module, "KotlinJavaRuntime")
        super.tearDown()
    }
}
